service: aggregation-appsync-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}

plugins:
  - serverless-appsync-plugin

custom:
  dynamodbTableName: ${cf:aggregation-dynamodb-resources-${self:provider.stage}.AggregationTableName}
  dynamodbTableArn: ${cf:aggregation-dynamodb-resources-${self:provider.stage}.AggregationTableArn}

# Moving appSync from custom to root level
appSync:
  name: AggregationAPI
  # Moving authentication configuration
  authentication:
    type: API_KEY
    apiKeys:
      - name: DefaultAPIKey
        description: Default API Key for GraphQL API
        expiresAfter: 30d
  # Renamed logConfig to logging
  logging:
    loggingRoleArn: !GetAtt AppSyncLoggingServiceRole.Arn
    level: ALL # Possible values: NONE, ERROR, ALL
  schema: schema.graphql
  # mappingTemplatesLocation is no longer needed as paths are relative to serverless.yml
  
  # Renamed mappingTemplates to resolvers and converted to key-value pairs with functions arrays
  resolvers:
    # Earliest loan application resolver
    Query.getEarliestLoanApplication:
      kind: PIPELINE
      functions:
        - name: getEarliestLoanApplicationFunction
          dataSource: AggregationDynamoDBTable
          request: mapping-templates/getEarliestLoanApplication-request.vtl
          response: mapping-templates/getEarliestLoanApplication-response.vtl
          substitutions:
            table: ${self:custom.dynamodbTableName}
    
    # Count applications within X months resolver
    Query.getLoanApplicationCountWithinMonths:
      kind: PIPELINE
      functions:
        - name: getLoanApplicationCountWithinMonthsFunction
          dataSource: AggregationDynamoDBTable
          request: mapping-templates/getLoanApplicationCountWithinMonths-request.vtl
          response: mapping-templates/getLoanApplicationCountWithinMonths-response.vtl
          substitutions:
            table: ${self:custom.dynamodbTableName}
    
    # Latest loan application by status resolver
    Query.getLatestLoanApplicationByStatus:
      kind: PIPELINE
      functions:
        - name: getLatestLoanApplicationByStatusFunction
          dataSource: AggregationDynamoDBTable
          request: mapping-templates/getLatestLoanApplicationByStatus-request.vtl
          response: mapping-templates/getLatestLoanApplicationByStatus-response.vtl
          substitutions:
            table: ${self:custom.dynamodbTableName}
  
  # Converted dataSources from array to key-value pairs
  dataSources:
    AggregationDynamoDBTable:
      type: AMAZON_DYNAMODB
      config:
        tableName: ${self:custom.dynamodbTableName}
        serviceRoleArn: !GetAtt AppSyncDynamoDBServiceRole.Arn

resources:
  Resources:
    AppSyncDynamoDBServiceRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: appsync.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
        Policies:
          - PolicyName: DynamoDBAccess
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:GetItem
                    - dynamodb:PutItem
                    - dynamodb:DeleteItem
                    - dynamodb:UpdateItem
                    - dynamodb:Query
                    - dynamodb:Scan
                    - dynamodb:BatchGetItem
                    - dynamodb:BatchWriteItem
                    - dynamodb:ExecuteStatement
                    - dynamodb:PartiQLSelect
                  Resource:
                    - ${self:custom.dynamodbTableArn}
                    - !Join ["", ["${self:custom.dynamodbTableArn}", "/index/*"]]
    # Add CloudWatch logging role
    AppSyncLoggingServiceRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service: appsync.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSAppSyncPushToCloudWatchLogs

  Outputs:
    GraphQLApiEndpoint:
      Value: !GetAtt GraphQlApi.GraphQLUrl
      Export:
        Name: ${self:service}-${self:provider.stage}-GraphQLApiEndpoint
    GraphQLApiId:
      Value: !GetAtt GraphQlApi.ApiId
      Export:
        Name: ${self:service}-${self:provider.stage}-GraphQLApiId 